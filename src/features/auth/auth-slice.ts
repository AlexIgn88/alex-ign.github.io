import { createSlice, createAsyncThunk, createSelector } from '@reduxjs/toolkit';
import type { PayloadAction } from '@reduxjs/toolkit';
import { API } from 'src/common/common-consts';
import { saveTokenToStorage } from 'src/features/auth/auth-thunks';
import { ApiError, SignUpBody, SignupSuccessResponse } from 'src/features/auth/auth-consts';
import { setProfile } from 'src/features/profile/profile-slice';
import { createFakeProfile } from 'src/features/profile/profile-consts';
import { RootState } from 'src/store/store';
import { useNavigate } from 'react-router-dom';

type AuthState = {
  token: string | null;
  isInitialized: boolean;
  error: ApiError[] | null;
};

const initialState: AuthState = {
  token: null,
  isInitialized: false,
  error: null,
};

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    setToken: (state, action: PayloadAction<string | null>) => {
      state.token = action.payload;
    },
    setInitialized: (state, action: PayloadAction<boolean>) => {
      state.isInitialized = action.payload;
    },
    removeToken: (state) => {
      state.token = null;
    },
    signupSagaRequest: (state, action: PayloadAction<{ data: SignUpBody; navigate: (path: string) => void }>) => {
      state.error = null;
    },
    signupSagaSuccess: (state) => {
      state.error = null;
    },
    signupSagaFailure: (state, action: PayloadAction<ApiError[]>) => {
      state.error = action.payload;
    },
  },
  extraReducers: (builder) => {
    builder
      .addCase(signup.pending, (state) => {
        state.error = null;
      })
      .addCase(signup.fulfilled, (state) => {
        state.error = null;
      })
      .addCase(signup.rejected, (state, action) => {
        state.error = action.payload;
      });
  },
});

export default authSlice.reducer;

export const { setToken, setInitialized, removeToken, signupSagaRequest, signupSagaSuccess, signupSagaFailure } =
  authSlice.actions;

export const selectAuthError = (state: RootState) => state.auth.error;

export const selectAuthErrorMessages = createSelector([selectAuthError], (error) => error?.map((e) => e.message) ?? []);

export const signup = createAsyncThunk<
  SignupSuccessResponse,
  { data: SignUpBody; navigate: ReturnType<typeof useNavigate> },
  { rejectValue: ApiError[] }
>('auth/signup', async ({ data, navigate }, { dispatch, rejectWithValue }) => {
  const response = await fetch(`/api${API.SIGNUP}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  });

  const result = await response.json();

  if (result.errors) {
    // console.log(result.errors);
    return rejectWithValue(result.errors as ApiError[]);
  }
  const { token, profile } = result;

  dispatch(saveTokenToStorage(token));
  dispatch(setProfile(createFakeProfile(token, profile)));
  navigate('/');
});
